<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Image Editor Pro - CronoTools</title>
    <style>
        /* Stile CSS v14.1 - Finale e Completo */
        :root, :root[data-theme="light"] { 
            --bg-primary: #f2f2f7; --bg-secondary: #ffffff; --bg-tertiary: #e5e5ea; 
            --bg-glass: rgba(255, 255, 255, 0.7); --text-primary: #000000; 
            --text-secondary: rgba(60, 60, 67, 0.6); --accent: #007aff; 
            --separator: rgba(60, 60, 67, 0.15); --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.12); 
            --radius-lg: 20px; 
        }
        [data-theme="dark"] { 
            --bg-primary: #000000; --bg-secondary: #1c1c1e; --bg-tertiary: #2c2c2e; 
            --bg-glass: rgba(28, 28, 30, 0.8); --text-primary: #ffffff; 
            --text-secondary: rgba(235, 235, 245, 0.6); --accent: #0a84ff; 
            --separator: rgba(84, 84, 88, 0.4); --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.4); 
        }
        [data-theme="midnight"] { 
            --bg-primary: #000000; --bg-secondary: #0a0a0a; --bg-tertiary: #1a1a1a; 
            --bg-glass: rgba(10, 10, 10, 0.9); --accent: #0a84ff; 
        }
        [data-theme="slate"] { 
            --bg-primary: #0a192f; --bg-secondary: #112240; --bg-tertiary: #233554; 
            --bg-glass: rgba(10, 25, 47, 0.85); --text-primary: #ccd6f6;
            --text-secondary: #8892b0; --accent: #f97316; 
            --separator: #112240; --shadow-md: 0 4px 20px rgba(0, 0, 0, 0.5);
        }
        [data-theme="latte"] { 
            --bg-primary: #EFF1F5; --bg-secondary: #FFFFFF; --bg-tertiary: #E6E9EF; 
            --bg-glass: rgba(239, 241, 245, 0.8); --text-primary: #4C4F69; 
            --text-secondary: #6C6F84; --accent: #8b5cf6; 
            --separator: #DCE0E8;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: var(--bg-primary); color: var(--text-primary); 
            transition: background 0.3s, color 0.3s; 
            -webkit-font-smoothing: antialiased;
        }
        body.no-scroll { overflow: hidden; }

        /* --- Navbar --- */
        #navbar { 
            position: fixed; top: 0; left: 0; right: 0; z-index: 100; 
            display: flex; align-items: center; justify-content: space-between; 
            background: transparent; border-bottom: 1px solid transparent; 
            height: 60px; padding: 0 24px; 
            transition: height 0.3s, background-color 0.3s, border-color 0.3s; 
        }
        #navbar.scrolled { 
            height: 44px; background-color: var(--bg-glass); 
            backdrop-filter: saturate(180%) blur(20px); -webkit-backdrop-filter: saturate(180%) blur(20px); 
            border-bottom-color: var(--separator); 
        }
        .nav-btn { background: none; border: none; color: var(--accent); cursor: pointer; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; border-radius: 8px; transition: background-color 0.2s; }
        .nav-btn:hover { background-color: var(--bg-tertiary); }
        .nav-placeholder { width: 44px; /* Bilancia il pulsante destro */ flex-shrink: 0; }
        .nav-center-links { display: flex; gap: 8px; transition: opacity 0.3s, transform 0.3s; }
        #navbar.scrolled .nav-center-links { opacity: 0; transform: scale(0.95); pointer-events: none; }
        .nav-link { color: var(--text-secondary); text-decoration: none; font-weight: 500; font-size: 15px; padding: 8px 12px; border-radius: 8px; transition: color 0.2s, background-color 0.2s; white-space: nowrap; }
        .nav-link:hover { color: var(--text-primary); background-color: var(--bg-tertiary); }
        .nav-link.active { color: var(--text-primary); font-weight: 600; }
        .nav-title { position: absolute; left: 50%; transform: translateX(-50%); font-size: 16px; font-weight: 600; opacity: 0; transition: opacity 0.3s; pointer-events: none; white-space: nowrap; }
        #navbar.scrolled .nav-title { opacity: 1; }

        /* --- Menu Laterali --- */
        .side-panel { position: fixed; top: 0; bottom: 0; z-index: 200; width: 300px; max-width: 85%; background-color: var(--bg-glass); backdrop-filter: saturate(180%) blur(20px); -webkit-backdrop-filter: saturate(180%) blur(20px); box-shadow: var(--shadow-md); transform: translateX(-100%); transition: transform 0.4s cubic-bezier(0.32, 0.72, 0, 1); overflow: hidden; padding: 16px; border-right: 1px solid var(--separator); display: flex; flex-direction: column; }
        .side-panel.right-panel { left: auto; right: 0; transform: translateX(100%); border-right: none; border-left: 1px solid var(--separator); }
        .side-panel.active { transform: translateX(0); }
        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-shrink: 0; }
        .panel-title { font-size: 13px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
        .close-btn { background: var(--bg-tertiary); border: none; color: var(--text-secondary); width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.3s, background-color 0.3s; }
        .close-btn:active { transform: scale(0.9); }
        .panel-content { flex-grow: 1; overflow-y: auto; }
        .panel-list { list-style: none; }
        .panel-link, .menu-item { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 8px; color: var(--text-primary); text-decoration: none; font-size: 17px; font-weight: 500; cursor: pointer; transition: background-color 0.2s; }
        .panel-link:hover, .menu-item:hover { background-color: var(--bg-tertiary); }
        .panel-link.active { background-color: var(--accent); color: white; font-weight: 600; }
        .menu-item .menu-item-arrow { margin-left: auto; color: var(--text-secondary); }
        .menu-back-btn { background: none; border: none; color: var(--accent); cursor: pointer; font-size: 17px; font-weight: 500; display: flex; align-items: center; }

        /* --- Dropdown (Desktop) --- */
        .dropdown-menu { position: absolute; top: 60px; right: 24px; z-index: 110; width: 300px; background-color: var(--bg-glass); backdrop-filter: saturate(180%) blur(20px); -webkit-backdrop-filter: saturate(180%) blur(20px); border-radius: var(--radius-lg); box-shadow: var(--shadow-md); border: 1px solid var(--separator); padding: 8px; opacity: 0; transform: translateY(-10px); transition: opacity 0.2s, transform 0.2s; pointer-events: none; }
        .dropdown-menu.active { opacity: 1; transform: translateY(0); pointer-events: auto; }

        /* --- Responsive --- */
        .mobile-only { display: none !important; }
        @media (max-width: 1024px) { /* Aumentato il breakpoint per nascondere i link prima */
            .desktop-only { display: none !important; }
            .mobile-only { display: flex !important; }
            #navbar.scrolled .nav-logo { display: flex; opacity: 1; transform: none; }
        }

        /* --- Backdrop --- */
        .backdrop { position: fixed; inset: 0; z-index: 150; background: rgba(0, 0, 0, 0.2); opacity: 0; transition: opacity 0.4s; pointer-events: none; }
        .backdrop.active { opacity: 1; pointer-events: all; }

        /* --- Stili Editor --- */
        .content-wrapper { max-width: 700px; margin: 0 auto; padding: 80px 16px 40px; }
        .main-header { margin-bottom: 32px; }
        .main-header h1 { font-size: 34px; font-weight: 700; margin-bottom: 8px; }
        .description { font-size: 17px; color: var(--text-secondary); }
        .glass-card { background: var(--bg-secondary); border-radius: var(--radius-lg); overflow: hidden; border: 1px solid var(--separator); }
        .upload-section { margin-bottom: 24px; }
        .dropzone { padding: 48px 24px; text-align: center; cursor: pointer; border: 2px dashed var(--separator); border-radius: var(--radius-lg); margin: 16px; transition: all 0.3s; }
        .dropzone:hover { border-color: var(--accent); }
        .dropzone.drag-over { border-color: var(--accent); background: rgba(0, 122, 255, 0.08); border-style: solid; }
        .upload-icon { width: 48px; height: 48px; color: var(--text-secondary); margin-bottom: 16px; }
        .dropzone-primary { font-size: 17px; font-weight: 600; }
        .dropzone-secondary { font-size: 15px; color: var(--text-secondary); }
        .section-title { font-size: 22px; font-weight: 700; margin-bottom: 16px; }
        .previews-section { margin-top: 40px; }
        .previews-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 16px; }
        .preview-item { position: relative; aspect-ratio: 1; border-radius: 14px; overflow: hidden; }
        .preview-canvas { width: 100%; height: 100%; object-fit: cover; }
        .filters-section, .conversion-section { margin-bottom: 24px; }
        .filters-scroll { display: flex; gap: 8px; overflow-x: auto; padding: 12px 16px; scrollbar-width: none; -ms-overflow-style: none; }
        .filters-scroll::-webkit-scrollbar { display: none; }
        .filter-chip { flex-shrink: 0; padding: 10px 20px; background: var(--bg-tertiary); border: none; border-radius: 28px; cursor: pointer; transition: all 0.3s; }
        .filter-chip.active { background: var(--accent); color: white; }
        .filter-name { font-size: 15px; font-weight: 500; white-space: nowrap; color: var(--text-primary); }
        .filter-chip.active .filter-name { color: white; }
        .conversion-row { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid var(--separator); }
        .conversion-label { font-size: 17px; }
        .conversion-select { padding: 8px 12px; border: none; background: var(--bg-tertiary); color: var(--text-primary); border-radius: 8px; font-size: 15px; cursor: pointer; }
        .convert-btn { width: 100%; padding: 16px; border: none; background: var(--accent); color: white; font-size: 17px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .convert-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .spinner { width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; display: none; }
        .convert-btn.loading .spinner { display: block; }
        .convert-btn.loading .btn-text { display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* --- Footer --- */
        .site-footer { padding: 40px 24px; margin-top: 40px; background: var(--bg-secondary); border-top: 1px solid var(--separator); color: var(--text-secondary); text-align: center; }
        .footer-content { max-width: 700px; margin: 0 auto; display: grid; gap: 24px; }
        .footer-content h4 { font-size: 18px; color: var(--text-primary); margin-bottom: 8px; }
        .footer-content p { font-size: 15px; line-height: 1.6; }
        .footer-content a { color: var(--accent); text-decoration: none; font-weight: 500; }
        .footer-content a:hover { text-decoration: underline; }
        .footer-bottom { margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--separator); font-size: 13px; }
    </style>
</head>
<body data-theme="dark">

    <aside class="side-panel left-panel" id="leftNavPanel">
        <div class="panel-header">
            <h3 class="panel-title" data-translate-key="siteNav">Navigazione</h3>
            <button class="close-btn" data-target="leftNavPanel">
                <svg width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
            </button>
        </div>
        <div class="panel-content">
            <ul class="panel-list" id="siteNavList"></ul>
        </div>
    </aside>

    <aside class="side-panel right-panel" id="rightFunctionsPanel"></aside>
    
    <div class="dropdown-menu" id="functionsDropdown"></div>

    <nav id="navbar">
        <button class="nav-btn mobile-only" id="leftMenuBtn">
            <svg width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"></path></svg>
        </button>
        <div class="nav-placeholder desktop-only"></div>
        <div class="nav-center-links desktop-only" id="desktopNavLinks"></div>
        <div class="nav-title" data-translate-key="toolName">CronoTools - Editor Immagini</div>
        <button class="nav-btn" id="rightMenuBtn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="5" r="2"></circle><circle cx="12" cy="12" r="2"></circle><circle cx="12" cy="19" r="2"></circle></svg>
        </button>
    </nav>

    <div class="content-wrapper">
        <header class="main-header">
            <h1 data-translate-key="mainTitle">Editor Immagini</h1>
            <p class="description" data-translate-key="description">Carica, applica filtri e converti le tue immagini.</p>
        </header>
        <main>
            <section class="glass-card upload-section">
                <div class="dropzone" id="dropzone"><svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg><p class="dropzone-text"><span class="dropzone-primary" data-translate-key="dropzonePrimary">Trascina i file qui</span><span class="dropzone-secondary" data-translate-key="dropzoneSecondary">o clicca per selezionare</span></p></div>
                <input type="file" id="fileInput" accept="image/*" multiple hidden>
            </section>
            <section class="previews-section" id="previewsSection" style="display: none;"><h2 class="section-title" data-translate-key="previewsTitle">Anteprime</h2><div class="previews-grid" id="previewsGrid"></div></section>
            <section class="filters-section" id="filtersSection" style="display: none;"><h2 class="section-title" data-translate-key="filtersTitle">Filtri</h2><div class="filters-scroll" id="filtersScroll"></div></section>
            <section class="conversion-section" id="conversionSection" style="display: none;"><div class="glass-card"><div class="conversion-row"><label class="conversion-label" data-translate-key="formatTitle">Formato Output</label><select class="conversion-select" id="formatSelect"><option value="jpeg">JPEG</option><option value="png">PNG</option><option value="webp">WebP</option></select></div><button class="convert-btn" id="convertBtn" disabled><span class="btn-text" data-translate-key="convertBtnDefault">Seleziona un'immagine</span><div class="spinner"></div></button></div></section>
        </main>
    </div>
    
    <footer class="site-footer">
        <div class="footer-content">
            <div>
                <h4 data-translate-key="footer_title_cronotools">CronoTools</h4>
                <p data-translate-key="footer_desc_cronotools">CronoTools è una suite di strumenti online gratuiti progettati per essere veloci, affidabili e rispettosi della tua privacy. Tutte le operazioni vengono eseguite localmente nel tuo browser, garantendo che i tuoi dati non lascino mai il tuo dispositivo.</p>
            </div>
            <div>
                <h4 data-translate-key="footer_title_cronoshop">Visita CronoShop.eu</h4>
                <p data-translate-key="footer_desc_cronoshop">Scopri il nostro e-commerce <a href="https://cronoshop.eu" target="_blank" rel="noopener noreferrer">CronoShop.eu</a> per una vasta gamma di prodotti di alta qualità. Supporta il nostro lavoro e trova fantastiche offerte.</p>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2024 CronoTools. Tutti i diritti riservati.</p>
        </div>
    </footer>
    
    <div class="backdrop" id="backdrop"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const dom = {
                navbar: document.getElementById('navbar'),
                largeTitle: document.querySelector('.main-header h1'),
                leftMenuBtn: document.getElementById('leftMenuBtn'),
                rightMenuBtn: document.getElementById('rightMenuBtn'),
                leftNavPanel: document.getElementById('leftNavPanel'),
                siteNavList: document.getElementById('siteNavList'),
                desktopNavLinks: document.getElementById('desktopNavLinks'),
                rightFunctionsPanel: document.getElementById('rightFunctionsPanel'),
                functionsDropdown: document.getElementById('functionsDropdown'),
                backdrop: document.getElementById('backdrop'),
                dropzone: document.getElementById('dropzone'),
                fileInput: document.getElementById('fileInput'),
                previewsSection: document.getElementById('previewsSection'),
                previewsGrid: document.getElementById('previewsGrid'),
                filtersSection: document.getElementById('filtersSection'),
                filtersScroll: document.getElementById('filtersScroll'),
                conversionSection: document.getElementById('conversionSection'),
                convertBtn: document.getElementById('convertBtn'),
                convertBtnText: document.querySelector('#convertBtn .btn-text'),
                formatSelect: document.getElementById('formatSelect'),
            };

            let images = new Map();
            let activeFilters = new Set(['none']);
            let currentLang = 'it';
            
            const siteFiles = ["index.html", "base64.html", "crop-immagini.html", "flip-immagini.html", "ridimensiona.html", "ruota-immagini.html", "scala-grigi.html", "share.html", "qr.html"];

            const translations = {
                it: {
                    toolName: "CronoTools - Editor Immagini", siteNav: "Navigazione", mainTitle: "Editor Immagini", description: "Carica, applica filtri e converti le tue immagini.",
                    dropzonePrimary: "Trascina i file qui", dropzoneSecondary: "o clicca per selezionare", previewsTitle: "Anteprime",
                    filtersTitle: "Filtri", formatTitle: "Formato Output", convertBtnDefault: "Seleziona un'immagine",
                    convertBtnActive: "Converti {count} Immagin{plural}", back: "Indietro", functions: "Funzioni", theme: "Tema",
                    language: "Lingua", light: "Default Chiaro", dark: "Default Scuro", midnight: "Midnight", slate: "Slate", latte: "Latte",
                    nav_index: "Converti Immagini", nav_base64: "Base64", nav_crop_immagini: "Ritaglia", nav_flip_immagini: "Specchia",
                    nav_ridimensiona: "Ridimensiona", nav_ruota_immagini: "Ruota", nav_scala_grigi: "Scala di Grigi", nav_share: "Condividi",
                    footer_title_cronotools: "CronoTools", footer_desc_cronotools: "CronoTools è una suite di strumenti online gratuiti progettati per essere veloci, affidabili e rispettosi della tua privacy. Tutte le operazioni vengono eseguite localmente nel tuo browser, garantendo che i tuoi dati non lascino mai il tuo dispositivo.",
                    footer_title_cronoshop: "Visita CronoShop.eu", footer_desc_cronoshop: "Scopri il nostro e-commerce CronoShop.eu per una vasta gamma di prodotti di alta qualità. Supporta il nostro lavoro e trova fantastiche offerte."
                },
                en: {
                    toolName: "CronoTools - Image Editor", siteNav: "Navigation", mainTitle: "Image Editor", description: "Upload, apply filters, and convert your images.",
                    dropzonePrimary: "Drag files here", dropzoneSecondary: "or click to select", previewsTitle: "Previews",
                    filtersTitle: "Filters", formatTitle: "Output Format", convertBtnDefault: "Select an image",
                    convertBtnActive: "Convert {count} Image{plural}", back: "Back", functions: "Functions", theme: "Theme",
                    language: "Language", light: "Default Light", dark: "Default Dark", midnight: "Midnight", slate: "Slate", latte: "Latte",
                    nav_index: "Image Converter", nav_base64: "Base64", nav_crop_immagini: "Crop", nav_flip_immagini: "Flip",
                    nav_ridimensiona: "Resize", nav_ruota_immagini: "Rotate", nav_scala_grigi: "Grayscale", nav_share: "Share",
                    footer_title_cronotools: "CronoTools", footer_desc_cronotools: "CronoTools is a suite of free online tools designed to be fast, reliable, and respectful of your privacy. All operations are performed locally in your browser, ensuring your data never leaves your device.",
                    footer_title_cronoshop: "Visit CronoShop.eu", footer_desc_cronoshop: "Discover our e-commerce CronoShop.eu for a wide range of high-quality products. Support our work and find great deals."
                }
            };
            
            // --- GESTIONE NAVIGAZIONE E MENU ---
            
            window.addEventListener('scroll', () => {
                const isScrolled = window.scrollY > 20;
                dom.navbar.classList.toggle('scrolled', isScrolled);
                if (dom.largeTitle) dom.largeTitle.classList.toggle('scrolled', isScrolled);
            }, { passive: true });

            const togglePanel = (panel) => {
                closeAllPanels();
                panel.classList.add('active');
                dom.backdrop.classList.add('active');
                document.body.classList.add('no-scroll');
            };

            const closeAllPanels = () => {
                document.querySelectorAll('.side-panel.active, .dropdown-menu.active').forEach(p => p.classList.remove('active'));
                dom.backdrop.classList.remove('active');
                document.body.classList.remove('no-scroll');
            };

            dom.leftMenuBtn.addEventListener('click', () => togglePanel(dom.leftNavPanel));
            dom.backdrop.addEventListener('click', closeAllPanels);
            document.querySelectorAll('.close-btn').forEach(btn => btn.addEventListener('click', closeAllPanels));

            const functionsMenuManager = {
                isDesktop: window.innerWidth > 1024,
                container: null,
                history: [],
                init() {
                    window.addEventListener('resize', () => { this.isDesktop = window.innerWidth > 1024; closeAllPanels(); });
                    dom.rightMenuBtn.addEventListener('click', (e) => this.toggle(e));
                },
                toggle(e) {
                    e.stopPropagation();
                    this.container = this.isDesktop ? dom.functionsDropdown : dom.rightFunctionsPanel;
                    const isActive = this.container.classList.contains('active');
                    closeAllPanels();
                    if (!isActive) {
                        this.history = [];
                        this.render(this.getMainMenuItems(), translations[currentLang].functions);
                        this.container.classList.add('active');
                        if (this.isDesktop) {
                            document.addEventListener('click', (event) => {
                                if (!this.container.contains(event.target) && !dom.rightMenuBtn.contains(event.target)) {
                                    closeAllPanels();
                                }
                            }, { once: true });
                        } else {
                             dom.backdrop.classList.add('active');
                             document.body.classList.add('no-scroll');
                        }
                    }
                },
                render(items, title) {
                    this.container.innerHTML = '';
                    const header = document.createElement('div');
                    header.className = 'panel-header';
                    
                    if (this.history.length > 0) {
                        const backBtn = document.createElement('button');
                        backBtn.className = 'menu-back-btn';
                        backBtn.innerHTML = `‹ <span data-translate-key="back">${translations[currentLang].back}</span>`;
                        backBtn.onclick = () => this.back();
                        header.appendChild(backBtn);
                    }
                    const panelTitle = document.createElement('h3');
                    panelTitle.className = 'panel-title';
                    panelTitle.textContent = title;
                    header.appendChild(panelTitle);
                    
                    if (!this.isDesktop) {
                        const closeBtn = document.createElement('button');
                        closeBtn.className = 'close-btn';
                        closeBtn.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>';
                        closeBtn.onclick = closeAllPanels;
                        header.appendChild(closeBtn);
                    }
                    
                    const list = document.createElement('ul');
                    list.className = 'panel-list';
                    items.forEach(itemData => {
                        const li = document.createElement('li');
                        li.className = 'menu-item';
                        li.innerHTML = `${itemData.icon || ''}<span class="menu-item-label">${itemData.label}</span>${itemData.submenu ? '<svg class="menu-item-arrow" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6z"></path></svg>' : ''}`;
                        li.onclick = (e) => {
                            e.stopPropagation();
                            if (itemData.submenu) {
                                this.history.push({items, title});
                                this.render(itemData.submenu(), itemData.label);
                            } else {
                                if (itemData.action) itemData.action();
                                closeAllPanels();
                            }
                        };
                        list.appendChild(li);
                    });
                    this.container.append(header, list);
                },
                back() {
                    const prevState = this.history.pop();
                    if (prevState) this.render(prevState.items, prevState.title);
                },
                getMainMenuItems: () => [
                    { label: translations[currentLang].theme, submenu: () => [
                        { label: translations[currentLang].light, action: () => setTheme('light') },
                        { label: translations[currentLang].dark, action: () => setTheme('dark') },
                        { label: translations[currentLang].midnight, action: () => setTheme('midnight') },
                        { label: translations[currentLang].slate, action: () => setTheme('slate') },
                        { label: translations[currentLang].latte, action: () => setTheme('latte') },
                    ]},
                    { label: translations[currentLang].language, submenu: () => [
                        { label: 'Italiano', action: () => setLanguage('it') },
                        { label: 'English', action: () => setLanguage('en') },
                    ]}
                ]
            };
            functionsMenuManager.init();
            
            function setTheme(theme) { document.body.setAttribute('data-theme', theme); localStorage.setItem('editorTheme', theme); }
            function setLanguage(lang) {
                currentLang = lang;
                localStorage.setItem('editorLang', lang);
                document.querySelectorAll('[data-translate-key]').forEach(el => {
                    const key = el.dataset.translateKey;
                    const target = el.classList.contains('btn-text') ? el : el;
                    if (translations[lang] && translations[lang][key]) {
                        target.textContent = translations[lang][key];
                    }
                });
                populateSiteNav();
                updateConvertButtonState();
                if (functionsMenuManager.container && functionsMenuManager.container.classList.contains('active')) {
                     functionsMenuManager.history = [];
                     functionsMenuManager.render(functionsMenuManager.getMainMenuItems(), translations[currentLang].functions);
                }
            }

            function populateSiteNav() {
                const targets = [dom.siteNavList, dom.desktopNavLinks];
                targets.forEach(t => { if(t) t.innerHTML = ''; });

                const fileMap = { "index.html": "Converti Immagini", ...Object.fromEntries(siteFiles.filter(f => f !== "index.html").map(f => [f, `nav_${f.replace('.html', '').replace(/-/g, '_')}`])) };
                
                Object.entries(fileMap).forEach(([file, key]) => {
                    const label = (translations[currentLang] && translations[currentLang][key]) || key;
                    
                    // Mobile
                    const li = document.createElement('li');
                    const aMobile = document.createElement('a');
                    aMobile.href = file;
                    aMobile.className = 'panel-link';
                    if (file === 'index.html') aMobile.classList.add('active');
                    aMobile.textContent = label;
                    li.appendChild(aMobile);
                    if (dom.siteNavList) dom.siteNavList.appendChild(li);

                    // Desktop
                    const aDesktop = document.createElement('a');
                    aDesktop.href = file;
                    aDesktop.className = 'nav-link';
                    if (file === 'index.html') aDesktop.classList.add('active');
                    aDesktop.textContent = label;
                    if (dom.desktopNavLinks) dom.desktopNavLinks.appendChild(aDesktop);
                });
            }

            // --- LOGICA EDITOR ---
            const FILTERS = { none: '', grayscale: 'grayscale(1)', sepia: 'sepia(1)', contrast: 'contrast(1.5)', brightness: 'brightness(1.2)', invert: 'invert(1)', vintage: 'sepia(0.6) contrast(1.1) brightness(0.9)'};

            function handleFiles(files) {
                for (const file of files) {
                    if (!file.type.startsWith('image/')) continue;
                    const id = `img-${Date.now()}-${Math.random()}`;
                    const reader = new FileReader();
                    reader.onload = e => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            canvas.className = 'preview-canvas';
                            images.set(id, { file, img, canvas });
                            renderPreview(id);
                            updateUIState();
                            applyAllFilters();
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            }

            function renderPreview(id) {
                const item = document.createElement('div'); item.className = 'preview-item'; item.id = id;
                const { canvas } = images.get(id);
                item.appendChild(canvas);
                dom.previewsGrid.appendChild(item);
            }

            function applyAllFilters() {
                const filterString = Array.from(activeFilters).map(f => FILTERS[f]).join(' ');
                for (const data of images.values()) {
                    const { img, canvas } = data;
                    const ctx = canvas.getContext('2d');
                    canvas.width = img.width; canvas.height = img.height;
                    ctx.filter = filterString;
                    ctx.drawImage(img, 0, 0);
                }
            }
            
            function initializeFilters() {
                dom.filtersScroll.innerHTML = '';
                 Object.keys(FILTERS).forEach(filterKey => {
                    const chip = document.createElement('button');
                    chip.className = 'filter-chip';
                    chip.dataset.filter = filterKey;
                    const filterName = filterKey.charAt(0).toUpperCase() + filterKey.slice(1).replace(/_/g, ' ');
                    chip.innerHTML = `<span class="filter-name">${filterName}</span>`;
                    if(filterKey === 'none') chip.classList.add('active');
                    chip.addEventListener('click', () => toggleFilter(filterKey));
                    dom.filtersScroll.appendChild(chip);
                });
            }

            function toggleFilter(filterName) {
                if (filterName === 'none') {
                    activeFilters.clear();
                    activeFilters.add('none');
                } else {
                    activeFilters.delete('none');
                    if (activeFilters.has(filterName)) {
                        activeFilters.delete(filterName);
                    } else {
                        activeFilters.add(filterName);
                    }
                    if (activeFilters.size === 0) {
                        activeFilters.add('none');
                    }
                }
                dom.filtersScroll.querySelectorAll('.filter-chip').forEach(chip => {
                    chip.classList.toggle('active', activeFilters.has(chip.dataset.filter));
                });
                applyAllFilters();
            }

            function updateUIState() {
                const hasImages = images.size > 0;
                dom.previewsSection.style.display = hasImages ? 'block' : 'none';
                dom.filtersSection.style.display = hasImages ? 'block' : 'none';
                dom.conversionSection.style.display = hasImages ? 'block' : 'none';
                dom.convertBtn.disabled = !hasImages;
                const count = images.size;
                const plural = count !== 1 ? 'e' : 'a';
                if (dom.convertBtnText) dom.convertBtnText.textContent = hasImages ? `Converti ${count} Immagin${plural}` : translations[currentLang].convertBtnDefault;
            }
            
            dom.dropzone.addEventListener('click', () => dom.fileInput.click());
            dom.fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
            ['dragover', 'dragleave', 'drop'].forEach(ev => {
                dom.dropzone.addEventListener(ev, e => {
                    e.preventDefault(); e.stopPropagation();
                    dom.dropzone.classList.toggle('drag-over', ev === 'dragover');
                    if (ev === 'drop') handleFiles(e.dataTransfer.files);
                });
            });

            dom.convertBtn.addEventListener('click', async () => {
                if (images.size === 0) return;
                dom.convertBtn.classList.add('loading');
                const format = dom.formatSelect.value;
                const downloads = [];
                 for (const data of images.values()) {
                    const blob = await new Promise(resolve => data.canvas.toBlob(resolve, `image/${format}`, 0.92));
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${data.file.name.split('.')[0]}-edited.${format}`;
                    downloads.push(a);
                }

                downloads.forEach((a, index) => {
                    setTimeout(() => {
                        a.click();
                        URL.revokeObjectURL(a.href);
                    }, index * 150);
                });
                
                setTimeout(() => {
                    dom.convertBtn.classList.remove('loading');
                }, downloads.length * 150 + 500);
            });
            
            // --- Inizializzazione ---
            const savedTheme = localStorage.getItem('editorTheme') || 'dark'; setTheme(savedTheme);
            const savedLang = localStorage.getItem('editorLang') || 'it'; setLanguage(savedLang);
            initializeFilters();
            updateUIState();
        });
    </script>
</body>
</html>
